import{u as N,j as e,C as S,l as W,P as g,F as K,S as V,D as _,a as p,h as J,p as Q,n as X,i as Y,r as h,k as Z,o as ee,q as se,t as R,v as ne,d as ae,w as te}from"./index-dKV-M6Wr.js";import{a as y,p as F}from"./soundUtils-DPOM3jWf.js";const oe=s=>new Promise((t,l)=>{const n=new FileReader;n.onload=r=>{t(r.target.result)},n.onerror=r=>{l(r)},n.readAsText(s)}),L=()=>{const s=N(),t=l=>{const n=l.target.files[0];n&&oe(n).then(r=>{try{const a=new S;a.loadPgn(r);const i=a.history(),o=[],c=a.header().Termination,u=a.header().Black||"-",m=a.header().White||"-",x=a.header().Result,v=[];a.reset(),o.push(a.fen()),i.forEach(j=>{const f=a.move(j);v.push({from:f.from,to:f.to}),o.push(a.fen())}),s(W({finalPos:o[o.length-1],moves:i,fens:o,fromToSquares:v,termination:c,result:x,blackPlayerName:u,whitePlayerName:m}))}catch(a){console.error("Error parsing PGN:",a)}}).catch(r=>{console.error("Error reading PGN file:",r)})};return e.jsxs("label",{className:"action-button",children:["Upload PGN",e.jsx("input",{type:"file",accept:".pgn",onChange:t,hidden:!0})]})};L.propTypes={onLoadPGN:g.func.isRequired};const re=()=>e.jsxs("nav",{className:"top-bar",children:[e.jsx(K,{}),e.jsx(L,{}),e.jsx(V,{}),e.jsx(_,{})]}),le=()=>e.jsx("div",{className:"top-container",children:e.jsx(re,{})}),B=({setPosition:s,handleMove:t})=>{const{fens:l}=p(u=>u.pgn),{currentMoveIndex:n}=p(u=>u.analysis),r=N(),a=()=>{y(),r(J()),s(l[0]),t()},i=()=>{n>0&&(F("move"),r(Q()),s(l[n-1]),t())},o=()=>{n<l.length-1&&(F("move"),r(X()),s(l[n+1]),t())},c=()=>{y(),r(Y()),s(l[l.length-1]),t()};return e.jsxs("div",{className:"move-navigation",children:[e.jsxs("button",{onClick:a,disabled:n===0,children:[e.jsx("span",{role:"img","aria-label":"gotostart",children:"⏮️"})," Start"]}),e.jsxs("button",{onClick:i,disabled:n===0,children:[e.jsx("span",{role:"img","aria-label":"previous",children:"⬅️"})," Prev"]}),e.jsxs("button",{onClick:o,disabled:n>=l.length-1,children:[e.jsx("span",{role:"img","aria-label":"next",children:"➡️"})," Next"]}),e.jsxs("button",{onClick:c,disabled:n===l.length-1,children:[e.jsx("span",{role:"img","aria-label":"last",children:"⏭️"})," Latest"]})]})};B.propTypes={setPosition:g.func.isRequired};const ie=()=>{const s=h.useRef(null),{moves:t,termination:l}=p(o=>o.pgn),{currentMoveIndex:n,fenLength:r}=p(o=>o.analysis),a=N();h.useEffect(()=>{s.current&&(s.current.scrollTop=s.current.scrollHeight)},[t]),h.useEffect(()=>{if(s.current){const o=s.current.querySelector(`.move-row-${n}`);o&&o.scrollIntoView({behavior:"smooth",block:"center"})}},[n]);const i=o=>{y(),a(Z(o))};return e.jsxs("div",{className:"move-history-wrapper",children:[n==r-1&&e.jsx("div",{className:"termination-msg",children:l}),e.jsx("div",{className:"move-history",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"#"}),e.jsx("th",{children:"White"}),e.jsx("th",{children:"Black"})]})}),e.jsx("tbody",{ref:s,children:t&&t.map((o,c)=>c%2===0?e.jsxs("tr",{className:`move-row-${c}`,children:[e.jsxs("td",{children:[Math.floor(c/2)+1,"."]}),e.jsx("td",{className:"clickable",style:{backgroundColor:c+1===n?"lightblue":"transparent"},onClick:()=>i(c+1),children:o}),e.jsx("td",{className:"clickable",style:{backgroundColor:c+2===n?"lightblue":"transparent"},onClick:()=>i(c+2),children:t[c+1]||""})]},c/2):null)})]})})]})},M=({className:s,handleMove:t,fen:l,lastMove:n,isFlipped:r,isFinalMove:a,result:i})=>{const o=(u,m)=>{t({from:u,to:m})},c=()=>a?ce(l,i):se(n);return e.jsx("div",{className:s,children:e.jsx(ee,{position:l,onPieceDrop:o,boardOrientation:r?"black":"white",customSquareStyles:c(),customDarkSquareStyle:{backgroundColor:"var(--dark-square)"},customLightSquareStyle:{backgroundColor:"var(--light-square)"}})})};M.defaultProps={isFinalMove:!1,result:""};M.prototype={isAnalysis:g.bool.isRequired,handleMove:g.func.isRequired,fen:g.string.isRequired,lastMove:g.object.isRequired,isFlipped:g.bool.isRequired,isFinalMove:g.bool.isFinalMove};const ce=(s,t)=>{const l=new S(s),n={},r=l.board(),a=R(r,"w"),i=R(r,"b");return t==="1-0"&&a&&(n[b(a.rank,a.file)]={backgroundColor:"var(--winner-king-background)"},n[b(i.rank,i.file)]={backgroundColor:"var(--loser-king-background)"}),t==="0-1"&&i&&(n[b(a.rank,a.file)]={backgroundColor:"var(--loser-king-background)"},n[b(i.rank,i.file)]={backgroundColor:"var(--winner-king-background)"}),n},b=(s,t)=>String.fromCharCode(t+97)+(8-s),de=({isFlipped:s,evalScore:t})=>{const l=n=>(Math.max(-10,Math.min(n,10))+10)/(2*10)*100;return e.jsx("div",{className:`eval-bar eval-container ${s?"flipped":""}`,children:e.jsx("div",{className:"white-bar",style:{height:`${l(t)}%`}})})},he=(s,t)=>t.split(" ")[1]==="w"?s:-s,ue=(s,t,l,n)=>{if(typeof s=="string"&&s.startsWith("info")&&s.includes("score")){const r=s.match(/score (cp|mate) (-?\d+)/);if(r){const i=r[1],o=parseInt(r[2],10);let c=0;i==="cp"?c=o/100:i==="mate"&&(c=o>0?10:-10);const u=he(c,n);t(u)}const a=s.match(/ pv (.+)/);a&&l(a[1])}},me=s=>{console.log("Stockfish message:",s)},pe=({fen:s})=>{const t=p(i=>i.engine.enabled),{initEngine:l,startSearch:n,stopSearch:r,terminateEngine:a}=ne(me,"lite",8e3);return h.useEffect(()=>(t?(l(),n(s)):(r("disabled by UI toggle"),a()),()=>{a()}),[t,s,l,n,r,a]),null},fe=()=>{const{fens:s,fromToSquares:t,moves:l,blackPlayerName:n,whitePlayerName:r}=p(d=>d.pgn),{currentMoveIndex:a}=p(d=>d.analysis),{result:i}=p(d=>d.pgn),[o,c]=h.useState(ae.START_FEN),u=h.useRef(o),{isFlipped:m,theme:x}=p(d=>d.settings),[v,j]=h.useState(0),[f,A]=h.useState(""),E=p(d=>d.engine.enabled),D=[{name:"Threads",value:1},{name:"Hash",value:16},{name:"MultiPV",value:1}],{initEngine:I,setOptions:$,startSearch:C,stopSearch:w,setOnMessage:G,syncEnabledState:P}=te(),O=h.useCallback(d=>{ue(d,j,A,u.current)},[]);h.useEffect(()=>{P(E)},[E,P]),h.useEffect(()=>{u.current=o},[o]);const z=()=>{I(),$(D),G(O)};h.useEffect(()=>{s&&s.length>0&&c(s[a])},[a,s,t]);const H=h.useCallback(({from:d,to:T})=>{console.log("handleMove",d,T);const k=new S(o);try{if(!k.move({from:d,to:T,promotion:"q"}))return;z(),c(k.fen()),w("handleMove"),C(k.fen())}catch(q){console.error(q)}},[o]),U=h.useCallback(()=>{w("navigateMove"),C(u.current)},[]);return e.jsxs("div",{children:[e.jsx(pe,{fen:o}),e.jsx(le,{}),e.jsxs("div",{className:"middle-container",children:[e.jsxs("div",{className:"left-menu-bar",children:[e.jsxs("p",{style:{color:"black",marginTop:"0.5rem"},children:["Eval: ",v]}),e.jsxs("p",{style:{color:"black",marginTop:"0.5rem"},children:["Best Line: ",f]})]}),e.jsxs("div",{className:`analysis-container ${x}-theme `,children:[e.jsxs("div",{className:"main-area",children:[e.jsx("div",{className:"top-name",children:e.jsx("div",{className:"player-names-wrapper",children:e.jsx("div",{className:`player-name ${m?"white-player-name":"black-player-name"}`,children:m?r:n})})}),e.jsxs("div",{className:"evalbar-board-container",children:[e.jsx(de,{isFlipped:m,evalScore:v}),e.jsx("div",{className:"board-wrapper",children:e.jsx(M,{className:"board",fen:o,isFlipped:m,lastMove:a>0&&a<s.length-1&&t?t[a-1]:null,handleMove:H,isFinalMove:a===s.length-1,result:i})})]}),e.jsx("div",{className:"bottom-name",children:e.jsx("div",{className:"player-names-wrapper",children:e.jsx("div",{className:`player-name ${m?"black-player-name":"white-player-name"}`,children:m?n:r})})})]}),e.jsxs("div",{className:"sidebar right-panel",children:[e.jsx(ie,{moves:l}),e.jsx(B,{setPosition:c,handleMove:U})]})]})]})]})};export{fe as default};
