import{u as x,j as e,C as S,l as W,a as m,f as K,S as V,D as _,d as J,p as Q,n as X,e as Y,r as h,g as Z,h as ee,c as se,i as ne}from"./index-D4LaAxBe.js";import{P as g,b as N,p as R,C as ae,g as te,d as F}from"./helpers-CMm5z_cn.js";const oe=s=>new Promise((t,o)=>{const n=new FileReader;n.onload=l=>{t(l.target.result)},n.onerror=l=>{o(l)},n.readAsText(s)}),B=()=>{const s=x(),t=o=>{const n=o.target.files[0];n&&oe(n).then(l=>{try{const a=new S;a.loadPgn(l);const i=a.history(),r=[],c=a.header().Termination,u=a.header().Black||"-",p=a.header().White||"-",j=a.header().Result,v=[];a.reset(),r.push(a.fen()),i.forEach(k=>{const f=a.move(k);v.push({from:f.from,to:f.to}),r.push(a.fen())}),s(W({finalPos:r[r.length-1],moves:i,fens:r,fromToSquares:v,termination:c,result:j,blackPlayerName:u,whitePlayerName:p}))}catch(a){console.error("Error parsing PGN:",a)}}).catch(l=>{console.error("Error reading PGN file:",l)})};return e.jsxs("label",{className:"action-button",children:["Upload PGN",e.jsx("input",{type:"file",accept:".pgn",onChange:t,hidden:!0})]})};B.propTypes={onLoadPGN:g.func.isRequired};const re=()=>{const s=x(),{isFlipped:t}=m(o=>o.game);return e.jsx("button",{onClick:()=>s(K()),className:"action-button",children:t?"Unflip Board":"Flip Board"})},le=()=>e.jsxs("nav",{className:"top-bar",children:[e.jsx(re,{}),e.jsx(B,{}),e.jsx(V,{}),e.jsx(_,{})]}),ie=()=>e.jsx("div",{className:"top-container",children:e.jsx(le,{})}),L=({setPosition:s,handleMove:t})=>{const{fens:o}=m(u=>u.pgn),{currentMoveIndex:n}=m(u=>u.analysis),l=x(),a=()=>{N(),l(J()),s(o[0]),t()},i=()=>{n>0&&(R("move"),l(Q()),s(o[n-1]),t())},r=()=>{n<o.length-1&&(R("move"),l(X()),s(o[n+1]),t())},c=()=>{N(),l(Y()),s(o[o.length-1]),t()};return e.jsxs("div",{className:"move-navigation",children:[e.jsxs("button",{onClick:a,disabled:n===0,children:[e.jsx("span",{role:"img","aria-label":"gotostart",children:"⏮️"})," Start"]}),e.jsxs("button",{onClick:i,disabled:n===0,children:[e.jsx("span",{role:"img","aria-label":"previous",children:"⬅️"})," Prev"]}),e.jsxs("button",{onClick:r,disabled:n>=o.length-1,children:[e.jsx("span",{role:"img","aria-label":"next",children:"➡️"})," Next"]}),e.jsxs("button",{onClick:c,disabled:n===o.length-1,children:[e.jsx("span",{role:"img","aria-label":"last",children:"⏭️"})," Latest"]})]})};L.propTypes={setPosition:g.func.isRequired};const ce=()=>{const s=h.useRef(null),{moves:t,termination:o}=m(r=>r.pgn),{currentMoveIndex:n,fenLength:l}=m(r=>r.analysis),a=x();h.useEffect(()=>{s.current&&(s.current.scrollTop=s.current.scrollHeight)},[t]),h.useEffect(()=>{if(s.current){const r=s.current.querySelector(`.move-row-${n}`);r&&r.scrollIntoView({behavior:"smooth",block:"center"})}},[n]);const i=r=>{N(),a(Z(r))};return e.jsxs("div",{className:"move-history-wrapper",children:[n==l-1&&e.jsx("div",{className:"termination-msg",children:o}),e.jsx("div",{className:"move-history",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"#"}),e.jsx("th",{children:"White"}),e.jsx("th",{children:"Black"})]})}),e.jsx("tbody",{ref:s,children:t&&t.map((r,c)=>c%2===0?e.jsxs("tr",{className:`move-row-${c}`,children:[e.jsxs("td",{children:[Math.floor(c/2)+1,"."]}),e.jsx("td",{className:"clickable",style:{backgroundColor:c+1===n?"lightblue":"transparent"},onClick:()=>i(c+1),children:r}),e.jsx("td",{className:"clickable",style:{backgroundColor:c+2===n?"lightblue":"transparent"},onClick:()=>i(c+2),children:t[c+1]||""})]},c/2):null)})]})})]})},C=({className:s,handleMove:t,fen:o,lastMove:n,isFlipped:l,isFinalMove:a,result:i})=>{const r=(u,p)=>{t({from:u,to:p})},c=()=>a?de(o,i):te(n);return e.jsx("div",{className:s,children:e.jsx(ae,{position:o,onPieceDrop:r,boardOrientation:l?"black":"white",customSquareStyles:c(),customDarkSquareStyle:{backgroundColor:"var(--dark-square)"},customLightSquareStyle:{backgroundColor:"var(--light-square)"}})})};C.defaultProps={isFinalMove:!1,result:""};C.prototype={isAnalysis:g.bool.isRequired,handleMove:g.func.isRequired,fen:g.string.isRequired,lastMove:g.object.isRequired,isFlipped:g.bool.isRequired,isFinalMove:g.bool.isFinalMove};const de=(s,t)=>{const o=new S(s),n={},l=o.board(),a=F(l,"w"),i=F(l,"b");return t==="1-0"&&a&&(n[b(a.rank,a.file)]={backgroundColor:"var(--winner-king-background)"},n[b(i.rank,i.file)]={backgroundColor:"var(--loser-king-background)"}),t==="0-1"&&i&&(n[b(a.rank,a.file)]={backgroundColor:"var(--loser-king-background)"},n[b(i.rank,i.file)]={backgroundColor:"var(--winner-king-background)"}),n},b=(s,t)=>String.fromCharCode(t+97)+(8-s),he=({isFlipped:s,evalScore:t})=>{const o=n=>(Math.max(-10,Math.min(n,10))+10)/(2*10)*100;return e.jsx("div",{className:`eval-bar eval-container ${s?"flipped":""}`,children:e.jsx("div",{className:"white-bar",style:{height:`${o(t)}%`}})})},ue=(s,t)=>t.split(" ")[1]==="w"?s:-s,me=(s,t,o,n)=>{if(typeof s=="string"&&s.startsWith("info")&&s.includes("score")){const l=s.match(/score (cp|mate) (-?\d+)/);if(l){const i=l[1],r=parseInt(l[2],10);let c=0;i==="cp"?c=r/100:i==="mate"&&(c=r>0?10:-10);const u=ue(c,n);t(u)}const a=s.match(/ pv (.+)/);a&&o(a[1])}},pe=s=>{console.log("Stockfish message:",s)},ge=({fen:s})=>{const t=m(i=>i.engine.enabled),{initEngine:o,startSearch:n,stopSearch:l,terminateEngine:a}=ee(pe,"lite",8e3);return h.useEffect(()=>(t?(o(),n(s)):(l("disabled by UI toggle"),a()),()=>{a()}),[t,s,o,n,l,a]),null},be=()=>{const{fens:s,fromToSquares:t,moves:o,blackPlayerName:n,whitePlayerName:l}=m(d=>d.pgn),{currentMoveIndex:a}=m(d=>d.analysis),{result:i}=m(d=>d.pgn),[r,c]=h.useState(se.START_FEN),u=h.useRef(r),{isFlipped:p,theme:j}=m(d=>d.settings),[v,k]=h.useState(0),[f,A]=h.useState(""),M=m(d=>d.engine.enabled),D=[{name:"Threads",value:1},{name:"Hash",value:16},{name:"MultiPV",value:1}],{initEngine:I,setOptions:$,startSearch:E,stopSearch:w,setOnMessage:G,syncEnabledState:P}=ne(),O=h.useCallback(d=>{me(d,k,A,u.current)},[]);h.useEffect(()=>{P(M)},[M,P]),h.useEffect(()=>{u.current=r},[r]);const U=()=>{I(),$(D),G(O)};h.useEffect(()=>{s&&s.length>0&&c(s[a])},[a,s,t]);const z=h.useCallback(({from:d,to:T})=>{console.log("handleMove",d,T);const y=new S(r);try{if(!y.move({from:d,to:T,promotion:"q"}))return;U(),c(y.fen()),w("handleMove"),E(y.fen())}catch(q){console.error(q)}},[r]),H=h.useCallback(()=>{w("navigateMove"),E(u.current)},[]);return e.jsxs("div",{children:[e.jsx(ge,{fen:r}),e.jsx(ie,{}),e.jsxs("div",{className:"middle-container",children:[e.jsxs("div",{className:"left-menu-bar",children:[e.jsxs("p",{style:{color:"black",marginTop:"0.5rem"},children:["Eval: ",v]}),e.jsxs("p",{style:{color:"black",marginTop:"0.5rem"},children:["Best Line: ",f]})]}),e.jsxs("div",{className:`analysis-container ${j}-theme `,children:[e.jsxs("div",{className:"main-area",children:[e.jsx("div",{className:"top-name",children:e.jsx("div",{className:"player-names-wrapper",children:e.jsx("div",{className:`player-name ${p?"white-player-name":"black-player-name"}`,children:p?l:n})})}),e.jsxs("div",{className:"evalbar-board-container",children:[e.jsx(he,{isFlipped:p,evalScore:v}),e.jsx("div",{className:"board-wrapper",children:e.jsx(C,{className:"board",fen:r,isFlipped:p,lastMove:a>0&&a<s.length-1&&t?t[a-1]:null,handleMove:z,isFinalMove:a===s.length-1,result:i})})]}),e.jsx("div",{className:"bottom-name",children:e.jsx("div",{className:"player-names-wrapper",children:e.jsx("div",{className:`player-name ${p?"black-player-name":"white-player-name"}`,children:p?n:l})})})]}),e.jsxs("div",{className:"sidebar right-panel",children:[e.jsx(ce,{moves:o}),e.jsx(L,{setPosition:c,handleMove:H})]})]})]})]})};export{be as default};
